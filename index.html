<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TimeTable Pro V3</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --sw:228px;--hh:52px;
  --bg:#eef2f7;--sb:#0b1628;--sbh:#162338;--acc:#1a56db;--acc2:#1648c8;
  --card:#fff;--border:#e2e8f0;--text:#1e293b;--muted:#64748b;
  --danger:#ef4444;--success:#10b981;--warn:#f59e0b;--info:#06b6d4;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Cairo',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;height:100vh;overflow:hidden}

/* ── HEADER ── */
.hdr{height:var(--hh);background:var(--sb);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 16px;flex-shrink:0;border-bottom:2px solid var(--acc)}
.hdr-logo{display:flex;align-items:center;gap:10px}
.hdr-logo i{color:var(--acc);font-size:20px}
.hdr-logo h1{font-size:15px;font-weight:700}
.hdr-logo span{font-size:10px;color:#94a3b8;display:block}
.hbtn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);color:#fff;padding:5px 12px;border-radius:6px;font-size:12px;cursor:pointer;font-family:'Cairo',sans-serif;display:flex;align-items:center;gap:6px;transition:.15s}
.hbtn:hover{background:rgba(255,255,255,.2)}
.hbtn.acc{background:var(--acc);border-color:var(--acc)}
.hbtn.acc:hover{background:var(--acc2)}

/* ── BODY ── */
.body-wrap{display:flex;flex:1;overflow:hidden}

/* ── SIDEBAR ── */
.sb{width:var(--sw);background:var(--sb);flex-shrink:0;display:flex;flex-direction:column;overflow:hidden}
.sb-nav{flex:1;padding:8px;overflow-y:auto}
.nl{color:#374151;font-size:9.5px;font-weight:700;padding:10px 8px 4px;letter-spacing:.06em;text-transform:uppercase}
.ni{display:flex;align-items:center;gap:9px;padding:8px 12px;border-radius:8px;cursor:pointer;color:#94a3b8;font-size:13px;font-weight:500;transition:.15s;margin-bottom:1px}
.ni i{width:16px;text-align:center;font-size:13px}
.ni:hover{background:var(--sbh);color:#e2e8f0}
.ni.on{background:var(--acc);color:#fff;font-weight:600}
.ni .badge{margin-right:auto;background:rgba(255,255,255,.18);color:#fff;font-size:10px;padding:1px 7px;border-radius:10px}
.sb-ft{padding:12px;border-top:1px solid #1a2e45;color:#4b5563;font-size:11px;text-align:center;cursor:pointer}
.sb-ft span{color:#94a3b8;font-weight:600;display:block;margin-top:2px}

/* ── MAIN ── */
.main{flex:1;overflow:hidden;display:flex;flex-direction:column}
.tp{display:none;flex:1;overflow:hidden;flex-direction:column}
.tp.on{display:flex}

/* ── SHARED UI ── */
.sh{padding:11px 20px;background:#fff;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.sh h2{font-size:14px;font-weight:700}
.sb2{flex:1;overflow-y:auto;padding:15px 20px}
.btn{padding:6px 14px;border-radius:8px;font-size:12px;font-weight:600;font-family:'Cairo',sans-serif;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:5px;transition:.15s}
.bp{background:var(--acc);color:#fff}.bp:hover{background:var(--acc2)}
.bd{background:#fee2e2;color:var(--danger)}.bd:hover{background:#fecaca}
.bs{background:#f1f5f9;color:var(--text)}.bs:hover{background:#e2e8f0}
.bw{background:#fef3c7;color:#92400e}.bw:hover{background:#fde68a}
.bv{background:#d1fae5;color:#065f46}.bv:hover{background:#a7f3d0}
.bi{background:#dbeafe;color:#1d4ed8}.bi:hover{background:#bfdbfe}
.bsm{padding:4px 9px;font-size:11px}
.dtbl{width:100%;background:#fff;border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,.06);overflow:hidden}
.dtbl table{width:100%;border-collapse:collapse}
.dtbl th{background:#f8fafc;padding:9px 12px;text-align:right;font-size:11px;color:var(--muted);font-weight:600;border-bottom:1px solid var(--border)}
.dtbl td{padding:8px 12px;font-size:12px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
.dtbl tr:last-child td{border-bottom:none}
.dtbl tr:hover td{background:#fafbfc}
.tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:600}
.es{text-align:center;padding:40px 20px;color:var(--muted)}
.es i{font-size:36px;margin-bottom:10px;color:#cbd5e1;display:block}
.es p{font-size:13px}

/* ── MODAL ── */
.mov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:999;align-items:center;justify-content:center}
.mov.on{display:flex}
.mbox{background:#fff;border-radius:16px;width:90%;max-width:520px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden;animation:mIn .2s ease}
.mbox.wide{max-width:780px}
@keyframes mIn{from{transform:translateY(-14px) scale(.97);opacity:0}to{transform:none;opacity:1}}
.mhd{background:var(--acc);color:#fff;padding:13px 18px;display:flex;align-items:center;justify-content:space-between}
.mhd h3{font-size:14px;font-weight:700}
.mhd button{background:none;border:none;color:#fff;cursor:pointer;font-size:15px}
.mbd{padding:18px;max-height:72vh;overflow-y:auto}
.mft{padding:11px 18px;background:#f8fafc;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
.fg{margin-bottom:13px}
.fg label{display:block;font-size:12px;font-weight:600;color:var(--text);margin-bottom:4px}
.fg input,.fg select,.fg textarea{width:100%;padding:7px 11px;border:1px solid var(--border);border-radius:8px;font-size:12px;font-family:'Cairo',sans-serif;outline:none;transition:.15s}
.fg input:focus,.fg select:focus{border-color:var(--acc);box-shadow:0 0 0 3px rgba(26,86,219,.1)}
.fg2{display:grid;grid-template-columns:1fr 1fr;gap:11px}
.fg3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:11px}
.day-btn{padding:5px 9px;border:2px solid var(--border);border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;background:#fff;color:var(--muted);font-family:'Cairo',sans-serif;transition:.15s;user-select:none}
.day-btn.on{background:var(--acc);border-color:var(--acc);color:#fff}
.csw{display:flex;gap:5px;flex-wrap:wrap}
.cs{width:22px;height:22px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:.1s}
.cs:hover{transform:scale(1.2)}
.cs.on{border-color:#1e293b;transform:scale(1.25)}

/* ── CONSTRAINTS PANEL ── */
.cst-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-bottom:16px}
.cst-card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06);border:1px solid var(--border)}
.cst-card h4{font-size:12px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:7px}
.slot-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:3px}
.slot-btn{
  aspect-ratio:1;border-radius:5px;border:none;cursor:pointer;font-size:10px;font-weight:600;
  transition:.12s;font-family:'Cairo',sans-serif;
  background:#f1f5f9;color:var(--muted);
}
.slot-btn:hover{background:#dbeafe;color:var(--acc)}
.slot-btn.blocked{background:#fee2e2;color:var(--danger)}
.slot-btn.preferred{background:#d1fae5;color:#065f46}
.slot-day-label{font-size:9px;font-weight:700;color:var(--muted);text-align:center;padding:2px 0}

/* ── CONSTRAINT LEGEND ── */
.cst-legend{display:flex;gap:12px;flex-wrap:wrap;font-size:11px;margin-bottom:10px;align-items:center}
.cst-legend span{display:flex;align-items:center;gap:4px}
.dot{width:10px;height:10px;border-radius:3px;display:inline-block}

/* ── GENERATOR ── */
.gen-body{flex:1;overflow-y:auto;padding:20px}
.gen-card{max-width:620px;margin:0 auto;background:#fff;border-radius:16px;padding:28px;box-shadow:0 2px 12px rgba(0,0,0,.08)}
.gen-title{text-align:center;margin-bottom:20px}
.gen-title i{font-size:44px;color:var(--acc);display:block;margin-bottom:10px}
.gen-title h2{font-size:20px;font-weight:800;margin-bottom:6px}
.gen-title p{color:var(--muted);font-size:12px;line-height:1.7}
.algo-opts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px}
.algo-opt{border:2px solid var(--border);border-radius:10px;padding:12px;cursor:pointer;transition:.15s;background:#fff}
.algo-opt:hover{border-color:var(--acc);background:#f0f6ff}
.algo-opt.on{border-color:var(--acc);background:#eff6ff}
.algo-opt h5{font-size:12px;font-weight:700;margin-bottom:4px;display:flex;align-items:center;gap:6px}
.algo-opt p{font-size:11px;color:var(--muted);line-height:1.5}
.opt-section{background:#f8fafc;border-radius:10px;padding:12px;margin-bottom:14px;border:1px solid var(--border)}
.opt-section h4{font-size:12px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:6px;color:var(--text)}
.opt-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.opt-row label{font-size:12px;color:var(--text)}
.opt-row input[type=range]{width:120px;accent-color:var(--acc)}
.opt-row .oval{font-size:11px;font-weight:700;color:var(--acc);min-width:24px;text-align:center}
.toggle-sw{position:relative;width:38px;height:20px;cursor:pointer}
.toggle-sw input{opacity:0;width:0;height:0;position:absolute}
.toggle-track{position:absolute;inset:0;background:#cbd5e1;border-radius:99px;transition:.2s}
.toggle-thumb{position:absolute;width:16px;height:16px;border-radius:50%;background:#fff;top:2px;right:2px;transition:.2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
.toggle-sw input:checked~.toggle-track{background:var(--acc)}
.toggle-sw input:checked~.toggle-thumb{right:calc(100% - 18px)}
.pb-wrap{background:#f1f5f9;border-radius:999px;height:10px;overflow:hidden;margin:14px 0;display:none}
.pb-fill{height:100%;background:linear-gradient(90deg,var(--acc),#38bdf8,var(--success));border-radius:999px;width:0;transition:width .18s}
.gen-logs{background:#0b1628;color:#38bdf8;border-radius:8px;padding:12px;font-size:11px;text-align:right;max-height:160px;overflow-y:auto;display:none;margin-top:12px;line-height:1.9;font-family:monospace}
.gen-logs .ok{color:#34d399}
.gen-logs .err{color:#f87171}
.gen-logs .info{color:#fbbf24}
.score-bar{display:flex;align-items:center;gap:8px;margin-top:10px;display:none}
.score-bar .sl{font-size:12px;color:var(--muted)}
.score-bar .sv{font-size:18px;font-weight:800;color:var(--acc)}

/* ── TIMETABLE ── */
.tt-wrap{flex:1;display:flex;overflow:hidden}
.tt-pool{width:215px;flex-shrink:0;background:#fff;border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.ph{padding:11px 13px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.ph .pt{font-size:13px;font-weight:700}
.ph .pc{font-size:11px;font-weight:700;padding:2px 8px;border-radius:10px;color:#fff}
.pb2{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:5px}

.pc-card{border-radius:10px;color:#fff;padding:8px 10px;cursor:grab;user-select:none;transition:transform .12s,box-shadow .12s,opacity .12s;display:flex;flex-direction:column;gap:3px;border:2px solid rgba(255,255,255,.22);position:relative}
.pc-card:hover{transform:scale(1.03);box-shadow:0 5px 16px rgba(0,0,0,.25)}
.pc-card.dragging{opacity:.3;transform:scale(.95)}
.pc-card .ps{font-size:12px;font-weight:700;line-height:1.2}
.pc-card .pm{font-size:10px;opacity:.85}
.pc-card .pn{position:absolute;top:5px;left:8px;background:rgba(0,0,0,.3);color:#fff;font-size:10px;font-weight:700;padding:1px 5px;border-radius:7px}

.tt-main{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--bg)}
.tbar{padding:9px 14px;background:#fff;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:9px;flex-shrink:0;flex-wrap:wrap}
.vtabs{display:flex;gap:3px}
.vt{padding:5px 13px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:#fff;color:var(--muted);font-family:'Cairo',sans-serif;transition:.15s}
.vt.on{background:var(--acc);border-color:var(--acc);color:#fff}
.tbar select{border:1px solid var(--border);border-radius:8px;padding:5px 9px;font-size:12px;font-family:'Cairo',sans-serif;outline:none;cursor:pointer;flex:1;max-width:210px}
.tbar select:focus{border-color:var(--acc)}
.narr{display:flex;gap:3px}
.narr button{width:27px;height:27px;border:1px solid var(--border);border-radius:6px;background:#fff;cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;transition:.1s}
.narr button:hover{background:var(--acc);border-color:var(--acc);color:#fff}
#cbadge{display:none;background:#fee2e2;color:#991b1b;padding:3px 9px;border-radius:6px;font-size:11px;font-weight:700;align-items:center;gap:4px}

.tgw{flex:1;overflow:auto;padding:14px}
.ttbl{border-collapse:separate;border-spacing:0;width:100%;background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.08)}
.ttbl th{background:#1e293b;color:#fff;padding:8px 5px;text-align:center;font-size:11px;font-weight:600;font-family:'Cairo',sans-serif;white-space:nowrap}
.ttbl th.dth{background:#0b1628;font-size:12px;border-left:1px solid #2d3f52;min-width:55px}
.ttbl th.eth{background:var(--acc);text-align:right;padding:8px 12px}
.ttbl th.pth{min-width:86px}

.tc{height:66px;border:1px solid #e4eaf2;padding:3px;vertical-align:top;position:relative;transition:background .1s;min-width:86px}
.tc.off{background:repeating-linear-gradient(45deg,#fef2f2,#fef2f2 3px,#fff8f8 3px,#fff8f8 9px)}
.tc.dho{background:#dbeafe!important;outline:2px dashed var(--acc);outline-offset:-2px}
.tc.dok{background:#d1fae5!important}
.tc.dno{background:#fee2e2!important;outline:2px dashed var(--danger);outline-offset:-2px}
.tc.blocked-slot{background:#fdf4ff;border:1px solid #e9d5ff}

.cl{height:100%;border-radius:8px;padding:4px 7px;color:#fff;font-size:10px;font-weight:600;display:flex;flex-direction:column;justify-content:space-between;cursor:grab;position:relative;overflow:hidden;transition:transform .1s,box-shadow .1s}
.cl:hover{transform:scale(1.03);box-shadow:0 4px 12px rgba(0,0,0,.22)}
.cl.dragging{opacity:.3}
.cl::after{content:'';position:absolute;top:0;right:0;width:3px;height:100%;background:rgba(255,255,255,.28)}
.cl .cs2{font-size:11px;font-weight:700}
.cl .cm2{font-size:10px;opacity:.85}
.cdel{position:absolute;top:2px;left:2px;width:15px;height:15px;border-radius:50%;background:rgba(0,0,0,.28);color:#fff;border:none;cursor:pointer;font-size:8px;display:none;align-items:center;justify-content:center;transition:background .1s;z-index:5}
.tc:hover .cdel{display:flex}
.cdel:hover{background:rgba(239,68,68,.8)}
.cph{height:100%;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#d1d5db;font-size:18px;transition:all .15s}
.tc:hover .cph{background:#f8fafc;color:#94a3b8}

/* ── OVERVIEW ── */
.ovw{flex:1;overflow:auto;padding:14px}
.ovtbl{border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.08);width:max-content;min-width:100%}
.ovtbl th,.ovtbl td{border:1px solid #e8edf3;padding:3px;font-size:10px;text-align:center;white-space:nowrap;height:34px;min-width:54px}
.ovtbl th{background:#1e293b;color:#fff;font-weight:600}
.ovtbl th.sc{background:#0b1628;position:sticky;right:0;z-index:5;min-width:128px;text-align:right;padding:3px 9px}
.ovtbl td.sc{position:sticky;right:0;background:#f8fafc;z-index:5;font-weight:600;text-align:right;padding:3px 9px;border-left:2px solid #cbd5e1}
.ovtbl .ds{border-left:2px solid #94a3b8!important}
.ovtbl .oc{background:#fff8f8}
.oc2{display:inline-block;padding:2px 5px;border-radius:4px;color:#fff;font-size:9px;font-weight:700}

/* ── REPORTS ── */
.rpg{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:14px}
.rpc{background:#fff;border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
.rpc h4{font-size:12px;font-weight:700;margin-bottom:9px;display:flex;align-items:center;justify-content:space-between}
.lb-w{margin-bottom:5px}
.lb-t{display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-bottom:3px}
.lb{height:7px;background:#f1f5f9;border-radius:99px;overflow:hidden}
.lbf{height:100%;border-radius:99px;transition:width .4s}

/* ── DRAG GHOST ── */
#dg{position:fixed;z-index:9999;pointer-events:none;opacity:.9;transform:translate(-50%,-52%);border-radius:9px;padding:7px 12px;color:#fff;font-size:12px;font-weight:700;font-family:'Cairo',sans-serif;box-shadow:0 8px 24px rgba(0,0,0,.35);display:none;white-space:nowrap;border:2px solid rgba(255,255,255,.3)}

/* ── SCORE WIDGET ── */
.score-widget{background:linear-gradient(135deg,#1a56db,#0ea5e9);color:#fff;border-radius:10px;padding:10px 14px;display:flex;align-items:center;gap:10px;margin-bottom:12px}
.score-widget .sw-val{font-size:28px;font-weight:900;line-height:1}
.score-widget .sw-lbl{font-size:11px;opacity:.85}
.score-widget .sw-sub{font-size:10px;opacity:.7;margin-top:2px}
.score-bars{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.score-item{background:#f8fafc;border-radius:8px;padding:8px 10px;border:1px solid var(--border)}
.score-item .si-lbl{font-size:10px;color:var(--muted);margin-bottom:4px}
.score-item .si-val{font-size:14px;font-weight:700}

::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px}

@media print{
  .sb,.hdr,.tbar,.tt-pool,.mov,#dg{display:none!important}
  body{overflow:visible}
  .body-wrap,.main,.tp,.tt-wrap,.tt-main,.tgw{overflow:visible;height:auto}
  .cdel{display:none!important}
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="hdr">
  <div class="hdr-logo">
    <i class="fas fa-th-large"></i>
    <div><h1>TimeTable Pro <span style="font-size:10px;background:var(--acc);padding:1px 6px;border-radius:4px;margin-right:4px">V3</span></h1><span>محرك الجدولة الذكي · التباديل والقيود</span></div>
  </div>
  <div style="display:flex;gap:7px">
    <button class="hbtn" onclick="window.print()"><i class="fas fa-print"></i> طباعة</button>
    <button class="hbtn acc" onclick="saveData()"><i class="fas fa-save"></i> حفظ</button>
  </div>
</header>

<div class="body-wrap">

<!-- SIDEBAR -->
<aside class="sb">
  <nav class="sb-nav">
    <div class="nl">الرئيسية</div>
    <div class="ni on" onclick="go('dash')"><i class="fas fa-home"></i>الرئيسة</div>
    <div class="nl">البيانات</div>
    <div class="ni" onclick="go('classes')"><i class="fas fa-door-open"></i>الفصول<span class="badge" id="nb-c">0</span></div>
    <div class="ni" onclick="go('teachers')"><i class="fas fa-user-tie"></i>المعلمون<span class="badge" id="nb-t">0</span></div>
    <div class="ni" onclick="go('assignments')"><i class="fas fa-link"></i>الإسناد<span class="badge" id="nb-a">0</span></div>
    <div class="nl">القيود</div>
    <div class="ni" onclick="go('constraints')"><i class="fas fa-ban"></i>قيود المعلمين<span class="badge" id="nb-cst">!</span></div>
    <div class="nl">الجدول</div>
    <div class="ni" onclick="go('generator')"><i class="fas fa-bolt"></i>التوليد والتحسين</div>
    <div class="ni" onclick="go('timetable')"><i class="fas fa-calendar-alt"></i>الجدول التفاعلي</div>
    <div class="ni" onclick="go('overview')"><i class="fas fa-table"></i>الجدول العام</div>
    <div class="ni" onclick="go('reports')"><i class="fas fa-chart-bar"></i>التقارير</div>
    <div class="nl">أخرى</div>
    <div class="ni" onclick="go('settings')"><i class="fas fa-cog"></i>الإعدادات</div>
  </nav>
  <div class="sb-ft" onclick="go('settings')">المدرسة<span id="school-lbl">غير محدد</span></div>
</aside>

<main class="main">

<!-- DASHBOARD -->
<div id="tp-dash" class="tp on">
  <div class="sb2">
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:16px">
      <div style="background:#fff;border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06);display:flex;align-items:center;gap:12px"><div style="width:40px;height:40px;border-radius:10px;background:#dbeafe;color:#1d4ed8;display:flex;align-items:center;justify-content:center;font-size:16px"><i class="fas fa-door-open"></i></div><div><div style="font-size:10px;color:var(--muted)">الفصول</div><div style="font-size:24px;font-weight:700" id="sc">0</div></div></div>
      <div style="background:#fff;border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06);display:flex;align-items:center;gap:12px"><div style="width:40px;height:40px;border-radius:10px;background:#d1fae5;color:#065f46;display:flex;align-items:center;justify-content:center;font-size:16px"><i class="fas fa-user-tie"></i></div><div><div style="font-size:10px;color:var(--muted)">المعلمون</div><div style="font-size:24px;font-weight:700" id="st">0</div></div></div>
      <div style="background:#fff;border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06);display:flex;align-items:center;gap:12px"><div style="width:40px;height:40px;border-radius:10px;background:#fef3c7;color:#92400e;display:flex;align-items:center;justify-content:center;font-size:16px"><i class="fas fa-tasks"></i></div><div><div style="font-size:10px;color:var(--muted)">الإسناد</div><div style="font-size:24px;font-weight:700" id="sa">0</div></div></div>
      <div style="background:#fff;border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06);display:flex;align-items:center;gap:12px"><div style="width:40px;height:40px;border-radius:10px;background:#d1fae5;color:#065f46;display:flex;align-items:center;justify-content:center;font-size:16px"><i class="fas fa-check-circle"></i></div><div><div style="font-size:10px;color:var(--muted)">موزعة</div><div style="font-size:24px;font-weight:700" id="ss">0</div></div></div>
      <div style="background:#fff;border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06);display:flex;align-items:center;gap:12px"><div style="width:40px;height:40px;border-radius:10px;background:#fee2e2;color:#991b1b;display:flex;align-items:center;justify-content:center;font-size:16px"><i class="fas fa-exclamation-circle"></i></div><div><div style="font-size:10px;color:var(--muted)">غير موزعة</div><div style="font-size:24px;font-weight:700;color:#ef4444" id="su">0</div></div></div>
    </div>
    <div id="dash-score" style="display:none" class="score-widget"><div><div class="sw-val" id="dsv">0</div><div class="sw-lbl">جودة الجدول</div><div class="sw-sub">من أصل 100 نقطة</div></div><div style="flex:1"><div id="dsb" style="height:8px;background:rgba(255,255,255,.3);border-radius:99px;overflow:hidden;margin-bottom:6px"><div id="dsbf" style="height:100%;background:#fff;border-radius:99px;transition:width .5s"></div></div><div id="dsd" style="font-size:11px;opacity:.8"></div></div></div>
    <div style="background:#fff;border-radius:12px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,.06)">
      <h4 style="font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px"><i class="fas fa-info-circle" style="color:var(--acc)"></i>كيفية الاستخدام</h4>
      <ol style="padding-right:18px">
        <li style="font-size:12px;color:var(--muted);margin-bottom:5px;line-height:1.6"><strong>الإعدادات:</strong> ضبط أيام الدراسة وعدد الحصص.</li>
        <li style="font-size:12px;color:var(--muted);margin-bottom:5px;line-height:1.6"><strong>الفصول والمعلمون:</strong> أضف البيانات الأساسية.</li>
        <li style="font-size:12px;color:var(--muted);margin-bottom:5px;line-height:1.6"><strong>الإسناد:</strong> حدد من يدرّس ماذا ولمن وكم حصة.</li>
        <li style="font-size:12px;color:var(--muted);margin-bottom:5px;line-height:1.6"><strong>قيود المعلمين:</strong> احجب حصصاً أو أياماً بعينها لكل معلم، أو ضع حصصاً مفضلة.</li>
        <li style="font-size:12px;color:var(--muted);margin-bottom:5px;line-height:1.6"><strong>التوليد:</strong> اختر الخوارزمية (Backtracking أو Greedy)، ضبط معاملات التحسين، ثم ابدأ.</li>
        <li style="font-size:12px;color:var(--muted);margin-bottom:5px;line-height:1.6"><strong>الجدول التفاعلي:</strong> اسحب الحصص وانقلها يدوياً.</li>
      </ol>
    </div>
  </div>
</div>

<!-- CLASSES -->
<div id="tp-classes" class="tp">
  <div class="sh"><h2><i class="fas fa-door-open" style="color:var(--acc);margin-left:7px"></i>إدارة الفصول</h2><button class="btn bp" onclick="openCM()"><i class="fas fa-plus"></i>إضافة فصل</button></div>
  <div class="sb2"><div class="dtbl"><table><thead><tr><th>اسم الفصل</th><th>المرحلة</th><th>الإجراءات</th></tr></thead><tbody id="cls-tb"></tbody></table></div><div id="cls-em" class="es" style="display:none"><i class="fas fa-door-open"></i><p>لا توجد فصول.</p></div></div>
</div>

<!-- TEACHERS -->
<div id="tp-teachers" class="tp">
  <div class="sh"><h2><i class="fas fa-user-tie" style="color:var(--acc);margin-left:7px"></i>إدارة المعلمين</h2><button class="btn bp" onclick="openTM()"><i class="fas fa-plus"></i>إضافة معلم</button></div>
  <div class="sb2"><div class="dtbl"><table><thead><tr><th>الاسم</th><th>التخصص</th><th>اللون</th><th>النصاب</th><th>أيام العمل</th><th>الإجراءات</th></tr></thead><tbody id="tch-tb"></tbody></table></div><div id="tch-em" class="es" style="display:none"><i class="fas fa-user-tie"></i><p>لا يوجد معلمون.</p></div></div>
</div>

<!-- ASSIGNMENTS -->
<div id="tp-assignments" class="tp">
  <div class="sh"><h2><i class="fas fa-link" style="color:var(--acc);margin-left:7px"></i>الإسناد</h2><div style="display:flex;gap:7px"><button class="btn bw" onclick="autoAssign()"><i class="fas fa-magic"></i>تلقائي</button><button class="btn bp" onclick="openAM()"><i class="fas fa-plus"></i>إضافة</button></div></div>
  <div class="sb2"><div class="dtbl"><table><thead><tr><th>المعلم</th><th>المادة</th><th>الفصل</th><th>الحصص</th><th>الإجراءات</th></tr></thead><tbody id="asg-tb"></tbody></table></div><div id="asg-em" class="es" style="display:none"><i class="fas fa-link"></i><p>لا يوجد إسناد.</p></div></div>
</div>

<!-- CONSTRAINTS -->
<div id="tp-constraints" class="tp">
  <div class="sh">
    <h2><i class="fas fa-ban" style="color:var(--danger);margin-left:7px"></i>قيود المعلمين</h2>
    <div style="display:flex;gap:7px">
      <select id="cst-teacher-sel" onchange="renderConstraints()" style="border:1px solid var(--border);border-radius:8px;padding:5px 9px;font-size:12px;font-family:'Cairo',sans-serif;outline:none"><option value="">-- اختر معلماً --</option></select>
    </div>
  </div>
  <div class="sb2" id="cst-body">
    <div class="es"><i class="fas fa-ban"></i><p>اختر معلماً لتحرير قيوده.</p></div>
  </div>
</div>

<!-- GENERATOR -->
<div id="tp-generator" class="tp">
  <div class="gen-body">
    <div class="gen-card">
      <div class="gen-title">
        <i class="fas fa-microchip"></i>
        <h2>محرك الجدولة الذكي</h2>
        <p>يستخدم التباديل والتوافق للعثور على الجدول الأمثل مع مراعاة جميع القيود</p>
      </div>

      <!-- Algorithm Selection -->
      <div class="opt-section">
        <h4><i class="fas fa-code-branch" style="color:var(--acc)"></i>خوارزمية التوزيع</h4>
        <div class="algo-opts">
          <div class="algo-opt on" id="algo-bt" onclick="selAlgo('bt')">
            <h5><i class="fas fa-sitemap" style="color:var(--acc)"></i>Backtracking + MRV</h5>
            <p>يستكشف كل التوافيق الممكنة مع تقليص الفضاء. أقوى وأدق، مثالي للجداول المعقدة.</p>
          </div>
          <div class="algo-opt" id="algo-gr" onclick="selAlgo('gr')">
            <h5><i class="fas fa-random" style="color:var(--warn)"></i>Greedy الجشعة</h5>
            <p>يوزع بسرعة عالية بالترتيب الأمثل. مناسب للجداول الكبيرة حيث السرعة مهمة.</p>
          </div>
        </div>
      </div>

      <!-- Optimization Options -->
      <div class="opt-section">
        <h4><i class="fas fa-sliders-h" style="color:var(--success)"></i>معاملات التحسين (Optimization Weights)</h4>
        <div class="opt-row"><label>تفادي الحصص المتتالية للمعلم</label><div style="display:flex;align-items:center;gap:6px"><input type="range" id="w-gap" min="0" max="10" value="7" oninput="document.getElementById('wv-gap').textContent=this.value"><span class="oval" id="wv-gap">7</span></div></div>
        <div class="opt-row"><label>توزيع متوازن يومياً</label><div style="display:flex;align-items:center;gap:6px"><input type="range" id="w-bal" min="0" max="10" value="8" oninput="document.getElementById('wv-bal').textContent=this.value"><span class="oval" id="wv-bal">8</span></div></div>
        <div class="opt-row"><label>احترام الحصص المفضلة</label><div style="display:flex;align-items:center;gap:6px"><input type="range" id="w-pref" min="0" max="10" value="5" oninput="document.getElementById('wv-pref').textContent=this.value"><span class="oval" id="wv-pref">5</span></div></div>
        <div class="opt-row"><label>تجميع حصص المعلم (قلة الفراغات)</label><div style="display:flex;align-items:center;gap:6px"><input type="range" id="w-comp" min="0" max="10" value="6" oninput="document.getElementById('wv-comp').textContent=this.value"><span class="oval" id="wv-comp">6</span></div></div>
        <div class="opt-row"><label>تفادي تكرار المادة بيوم واحد للفصل</label><div style="display:flex;align-items:center;gap:6px"><input type="range" id="w-rep" min="0" max="10" value="9" oninput="document.getElementById('wv-rep').textContent=this.value"><span class="oval" id="wv-rep">9</span></div></div>
      </div>

      <!-- Post-gen Optimization -->
      <div class="opt-section">
        <h4><i class="fas fa-magic" style="color:var(--warn)"></i>مرحلة التحسين بعد التوليد</h4>
        <div class="opt-row">
          <label>تفعيل Local Search (تبادل الحصص لتحسين الجودة)</label>
          <label class="toggle-sw"><input type="checkbox" id="opt-ls" checked><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
        </div>
        <div class="opt-row"><label>عدد محاولات التبادل</label><div style="display:flex;align-items:center;gap:6px"><input type="range" id="opt-itr" min="100" max="2000" step="100" value="500" oninput="document.getElementById('ovl-itr').textContent=this.value"><span class="oval" id="ovl-itr">500</span></div></div>
        <div class="opt-row">
          <label>Simulated Annealing (تحسين عميق، أبطأ)</label>
          <label class="toggle-sw"><input type="checkbox" id="opt-sa"><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
        </div>
      </div>

      <div class="pb-wrap" id="pbw"><div class="pb-fill" id="pbf"></div></div>
      <div style="display:flex;gap:9px;justify-content:center;flex-wrap:wrap">
        <button class="btn bd" onclick="clearSched()"><i class="fas fa-trash"></i>مسح الجدول</button>
        <button class="btn bp" id="gen-btn" onclick="runGen()" style="padding:9px 28px;font-size:13px"><i class="fas fa-play"></i>بدء التوزيع</button>
      </div>
      <div class="gen-logs" id="gen-logs"></div>
      <div class="score-bar" id="score-bar"><span class="sl">جودة الجدول:</span><span class="sv" id="score-val">—</span><span class="sl">/ 100</span></div>
    </div>
  </div>
</div>

<!-- TIMETABLE -->
<div id="tp-timetable" class="tp">
  <div class="tt-wrap">
    <div class="tt-main">
      <div class="tbar">
        <div class="vtabs"><button class="vt on" id="vtc" onclick="setView('class',this)">عرض الفصل</button><button class="vt" id="vtt" onclick="setView('teacher',this)">عرض المعلم</button></div>
        <div class="narr"><button onclick="navPrev()"><i class="fas fa-chevron-right"></i></button><button onclick="navNext()"><i class="fas fa-chevron-left"></i></button></div>
        <select id="ent-sel" onchange="selEnt(this.value)"></select>
        <div id="cbadge"><i class="fas fa-exclamation-triangle"></i>تعارض!</div>
      </div>
      <div class="tgw"><table class="ttbl" id="tbl"></table></div>
    </div>
    <div class="tt-pool">
      <div class="ph"><span class="pt"><i class="fas fa-layer-group" style="color:var(--acc);margin-left:5px"></i>غير موزعة</span><span class="pc" id="pool-badge">0</span></div>
      <div class="pb2" id="pool-body" ondragover="event.preventDefault()" ondrop="poolDrop(event)"></div>
    </div>
  </div>
</div>

<!-- OVERVIEW -->
<div id="tp-overview" class="tp">
  <div class="sh"><h2><i class="fas fa-table" style="color:var(--acc);margin-left:7px"></i>الجدول العام</h2>
    <div class="vtabs"><button class="vt on" id="ovt-btn" onclick="setOV('teacher')">حسب المعلم</button><button class="vt" id="ovc-btn" onclick="setOV('class')">حسب الفصل</button></div>
  </div>
  <div class="ovw"><table class="ovtbl" id="ovtbl"></table></div>
</div>

<!-- REPORTS -->
<div id="tp-reports" class="tp">
  <div class="sh"><h2><i class="fas fa-chart-bar" style="color:var(--acc);margin-left:7px"></i>التقارير والتحليل</h2></div>
  <div class="sb2">
    <div id="rp-score" style="display:none;margin-bottom:14px"></div>
    <div class="rpg" id="rpg"></div>
  </div>
</div>

<!-- SETTINGS -->
<div id="tp-settings" class="tp">
  <div class="sh"><h2><i class="fas fa-cog" style="color:var(--acc);margin-left:7px"></i>الإعدادات</h2><button class="btn bp" onclick="saveSettings()"><i class="fas fa-save"></i>حفظ</button></div>
  <div class="sb2">
    <div style="margin-bottom:20px"><h3 style="font-size:13px;font-weight:700;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--border)">معلومات المدرسة</h3>
      <div class="fg2"><div class="fg"><label>اسم المدرسة</label><input type="text" id="s-name" placeholder="مدرسة النجاح الابتدائية"></div><div class="fg"><label>المرحلة</label><select id="s-stage"><option>ابتدائية</option><option>متوسطة</option><option>ثانوية</option></select></div></div>
    </div>
    <div><h3 style="font-size:13px;font-weight:700;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--border)">إعدادات الجدول</h3>
      <div class="fg2"><div class="fg"><label>عدد الحصص في اليوم</label><input type="number" id="s-per" min="4" max="10" value="7"></div></div>
      <div class="fg"><label>أيام الدراسة</label><div style="display:flex;gap:6px;flex-wrap:wrap" id="s-days"></div></div>
    </div>
  </div>
</div>

</main>
</div>

<div id="dg"></div>

<!-- ═══ MODALS ═══ -->
<div class="mov" id="cm"><div class="mbox"><div class="mhd"><h3 id="cm-ttl">إضافة فصل</h3><button onclick="closeM('cm')"><i class="fas fa-times"></i></button></div><div class="mbd"><input type="hidden" id="cm-id"><div class="fg2"><div class="fg"><label>اسم الفصل</label><input type="text" id="cm-n" placeholder="1/أ"></div><div class="fg"><label>المرحلة</label><select id="cm-g"><option>الصف الأول</option><option>الصف الثاني</option><option>الصف الثالث</option><option>الصف الرابع</option><option>الصف الخامس</option><option>الصف السادس</option></select></div></div></div><div class="mft"><button class="btn bs" onclick="closeM('cm')">إلغاء</button><button class="btn bp" onclick="saveClass()">حفظ</button></div></div></div>

<div class="mov" id="tm"><div class="mbox" style="max-width:530px"><div class="mhd"><h3 id="tm-ttl">إضافة معلم</h3><button onclick="closeM('tm')"><i class="fas fa-times"></i></button></div><div class="mbd"><input type="hidden" id="tm-id"><div class="fg"><label>الاسم الثلاثي</label><input type="text" id="tm-n" placeholder="محمد عبدالله الغامدي"></div><div class="fg2"><div class="fg"><label>التخصص</label><select id="tm-s"><option>الرياضيات</option><option>العلوم</option><option>اللغة العربية</option><option>اللغة الإنجليزية</option><option>التربية الإسلامية</option><option>الاجتماعيات</option><option>التربية الفنية</option><option>التربية البدنية</option><option>الحاسب الآلي</option><option>أخرى</option></select></div><div class="fg"><label>النصاب الأسبوعي</label><input type="number" id="tm-m" value="20" min="1" max="40"></div></div><div class="fg"><label>لون المعلم</label><div class="csw" id="tm-clr"></div></div><div class="fg"><label>أيام الدوام</label><div style="display:flex;gap:6px;flex-wrap:wrap" id="tm-days"></div></div></div><div class="mft"><button class="btn bs" onclick="closeM('tm')">إلغاء</button><button class="btn bp" onclick="saveTeacher()">حفظ</button></div></div></div>

<div class="mov" id="am"><div class="mbox"><div class="mhd"><h3>إضافة إسناد</h3><button onclick="closeM('am')"><i class="fas fa-times"></i></button></div><div class="mbd"><div class="fg"><label>المعلم</label><select id="am-t"></select></div><div class="fg2"><div class="fg"><label>الفصل</label><select id="am-c"></select></div><div class="fg"><label>عدد الحصص الأسبوعية</label><input type="number" id="am-n" value="5" min="1" max="20"></div></div></div><div class="mft"><button class="btn bs" onclick="closeM('am')">إلغاء</button><button class="btn bp" onclick="saveAssign()">إضافة</button></div></div></div>

<script>
// ══════════════════════════════════════════
//  DATA MODEL
// ══════════════════════════════════════════
const COLORS=['#ef4444','#f97316','#f59e0b','#84cc16','#10b981','#06b6d4','#3b82f6','#6366f1','#8b5cf6','#d946ef','#f43f5e','#0ea5e9','#14b8a6','#b45309','#1d4ed8'];
const DAYS=['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];

let D={
  school:{name:'',stage:'ابتدائية',periods:7,schoolDays:[0,1,2,3,4]},
  classes:[],teachers:[],assignments:[],
  // constraints[teacherId] = {blocked:[[d,p],...], preferred:[[d,p],...], maxConsec:3, maxPerDay:6}
  constraints:{},
  schedule:{} // schedule[d][p][classId]={teacherId,subject,color,assignId}
};

function saveData(){ localStorage.setItem('ttpv3',JSON.stringify(D)); toast('تم الحفظ','ok'); }
function loadData(){ try{ const s=localStorage.getItem('ttpv3'); if(s) D=JSON.parse(s); }catch(e){} fixSched(); }
function fixSched(){ D.school.schoolDays.forEach(d=>{ if(!D.schedule[d]) D.schedule[d]={}; for(let p=0;p<D.school.periods;p++) if(!D.schedule[d][p]) D.schedule[d][p]={}; }); }

function toast(msg,type='info'){
  const el=document.createElement('div');
  const bg=type==='ok'?'#10b981':type==='err'?'#ef4444':type==='warn'?'#f59e0b':'#1a56db';
  el.style.cssText=`position:fixed;bottom:22px;left:50%;transform:translateX(-50%);background:${bg};color:#fff;padding:9px 20px;border-radius:9px;font-size:12px;font-weight:600;z-index:9999;box-shadow:0 4px 16px rgba(0,0,0,.3);font-family:Cairo,sans-serif;transition:opacity .3s`;
  el.textContent=msg; document.body.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),300); },2300);
}

const $q=(s,r=document)=>r.querySelector(s);
const $a=(s,r=document)=>[...r.querySelectorAll(s)];

// ══════════════════════════════════════════
//  NAVIGATION
// ══════════════════════════════════════════
function go(id){
  $a('.tp').forEach(p=>p.classList.remove('on'));
  $a('.ni').forEach(n=>n.classList.remove('on'));
  document.getElementById('tp-'+id).classList.add('on');
  const ni=$q(`.ni[onclick*="'${id}'"]`); if(ni) ni.classList.add('on');
  if(id==='timetable'){ renderPool(); renderGrid(); }
  if(id==='overview') renderOV();
  if(id==='reports') renderRP();
  if(id==='classes') renderCLS();
  if(id==='teachers') renderTCH();
  if(id==='assignments') renderASG();
  if(id==='constraints') fillConstraintSel();
  updateStats();
}

// ══════════════════════════════════════════
//  SETTINGS
// ══════════════════════════════════════════
function initSettings(){
  $q('#s-name').value=D.school.name;
  $q('#s-per').value=D.school.periods;
  $q('#s-stage').value=D.school.stage;
  const el=$q('#s-days'); el.innerHTML='';
  DAYS.forEach((n,i)=>{ const b=document.createElement('span'); b.className='day-btn'+(D.school.schoolDays.includes(i)?' on':''); b.dataset.day=i; b.textContent=n; b.onclick=()=>b.classList.toggle('on'); el.appendChild(b); });
}
function saveSettings(){
  D.school.name=$q('#s-name').value.trim();
  D.school.stage=$q('#s-stage').value;
  D.school.periods=+$q('#s-per').value;
  D.school.schoolDays=$a('#s-days .day-btn.on').map(b=>+b.dataset.day);
  fixSched(); $q('#school-lbl').textContent=D.school.name||'غير محدد';
  toast('تم حفظ الإعدادات','ok'); updateStats();
}

// ══════════════════════════════════════════
//  CLASSES
// ══════════════════════════════════════════
function openCM(id=null){
  $q('#cm-id').value=id||'';
  if(id){ const c=D.classes.find(x=>x.id===id); $q('#cm-ttl').textContent='تعديل فصل'; $q('#cm-n').value=c.name; $q('#cm-g').value=c.grade; }
  else{ $q('#cm-ttl').textContent='إضافة فصل'; $q('#cm-n').value=''; }
  openM('cm');
}
function saveClass(){
  const id=$q('#cm-id').value, name=$q('#cm-n').value.trim(), grade=$q('#cm-g').value;
  if(!name) return toast('أدخل اسم الفصل','err');
  if(id) Object.assign(D.classes.find(x=>x.id===id),{name,grade});
  else D.classes.push({id:'c'+Date.now(),name,grade});
  closeM('cm'); renderCLS(); updateStats();
}
function delCLS(id){ if(!confirm('حذف الفصل؟')) return; D.classes=D.classes.filter(c=>c.id!==id); D.assignments=D.assignments.filter(a=>a.classId!==id); Object.values(D.schedule).forEach(dy=>Object.values(dy).forEach(p=>delete p[id])); renderCLS(); updateStats(); }
function renderCLS(){
  const tb=$q('#cls-tb'), em=$q('#cls-em'); tb.innerHTML='';
  if(!D.classes.length){ em.style.display='block'; return; } em.style.display='none';
  D.classes.forEach(c=>{ tb.innerHTML+=`<tr><td><strong>${c.name}</strong></td><td><span class="tag" style="background:#dbeafe;color:#1d4ed8">${c.grade}</span></td><td><button class="btn bs bsm" onclick="openCM('${c.id}')"><i class="fas fa-edit"></i></button> <button class="btn bd bsm" onclick="delCLS('${c.id}')"><i class="fas fa-trash"></i></button></td></tr>`; });
  $q('#nb-c').textContent=D.classes.length;
}

// ══════════════════════════════════════════
//  TEACHERS
// ══════════════════════════════════════════
function openTM(id=null){
  const sw=$q('#tm-clr'); sw.innerHTML='';
  COLORS.forEach(c=>{ const s=document.createElement('span'); s.className='cs'; s.style.background=c; s.dataset.c=c; s.onclick=()=>{ $a('.cs',sw).forEach(x=>x.classList.remove('on')); s.classList.add('on'); }; sw.appendChild(s); });
  const de=$q('#tm-days'); de.innerHTML='';
  DAYS.forEach((n,i)=>{ const b=document.createElement('span'); b.className='day-btn'; b.dataset.day=i; b.textContent=n; b.onclick=()=>b.classList.toggle('on'); de.appendChild(b); });
  $q('#tm-id').value=id||'';
  if(id){
    const t=D.teachers.find(x=>x.id===id);
    $q('#tm-ttl').textContent='تعديل معلم'; $q('#tm-n').value=t.name; $q('#tm-s').value=t.subject; $q('#tm-m').value=t.maxLoad;
    $a(`.cs[data-c="${t.color}"]`,sw)[0]?.classList.add('on');
    $a('[data-day]',de).forEach(b=>b.classList.toggle('on',t.workingDays.includes(+b.dataset.day)));
  } else {
    $q('#tm-ttl').textContent='إضافة معلم'; $q('#tm-n').value=''; $q('#tm-m').value=20;
    sw.children[0]?.classList.add('on');
    $a('[data-day]',de).forEach(b=>b.classList.toggle('on',D.school.schoolDays.includes(+b.dataset.day)));
  }
  openM('tm');
}
function saveTeacher(){
  const id=$q('#tm-id').value, name=$q('#tm-n').value.trim(), subject=$q('#tm-s').value;
  const maxLoad=+$q('#tm-m').value;
  const color=$a('.cs.on',$q('#tm-clr'))[0]?.dataset.c||COLORS[0];
  const workingDays=$a('.day-btn.on',$q('#tm-days')).map(b=>+b.dataset.day);
  if(!name) return toast('أدخل اسم المعلم','err');
  if(id) Object.assign(D.teachers.find(x=>x.id===id),{name,subject,maxLoad,color,workingDays});
  else D.teachers.push({id:'t'+Date.now(),name,subject,maxLoad,color,workingDays});
  closeM('tm'); renderTCH(); updateStats();
}
function delTCH(id){ if(!confirm('حذف المعلم؟')) return; D.teachers=D.teachers.filter(t=>t.id!==id); D.assignments=D.assignments.filter(a=>a.teacherId!==id); Object.values(D.schedule).forEach(dy=>Object.values(dy).forEach(p=>{ Object.keys(p).forEach(cid=>{ if(p[cid]?.teacherId===id) delete p[cid]; }); })); renderTCH(); updateStats(); }
function renderTCH(){
  const tb=$q('#tch-tb'), em=$q('#tch-em'); tb.innerHTML='';
  if(!D.teachers.length){ em.style.display='block'; return; } em.style.display='none';
  D.teachers.forEach(t=>{ tb.innerHTML+=`<tr><td><strong>${t.name}</strong></td><td><span class="tag" style="background:#f0fdf4;color:#166534">${t.subject}</span></td><td><span style="display:inline-block;width:16px;height:16px;border-radius:50%;background:${t.color};border:2px solid #e2e8f0"></span></td><td><strong>${t.maxLoad}</strong> حصة</td><td style="font-size:10px;color:var(--muted)">${t.workingDays.map(d=>DAYS[d]).join(' · ')}</td><td><button class="btn bs bsm" onclick="openTM('${t.id}')"><i class="fas fa-edit"></i></button> <button class="btn bd bsm" onclick="delTCH('${t.id}')"><i class="fas fa-trash"></i></button></td></tr>`; });
  $q('#nb-t').textContent=D.teachers.length;
}

// ══════════════════════════════════════════
//  ASSIGNMENTS
// ══════════════════════════════════════════
function openAM(){
  const ts=$q('#am-t'); ts.innerHTML='<option value="">-- اختر المعلم --</option>'; D.teachers.forEach(t=>ts.innerHTML+=`<option value="${t.id}">${t.name} (${t.subject})</option>`);
  const cs=$q('#am-c'); cs.innerHTML='<option value="">-- اختر الفصل --</option>'; D.classes.forEach(c=>cs.innerHTML+=`<option value="${c.id}">${c.name} - ${c.grade}</option>`);
  openM('am');
}
function saveAssign(){
  const tid=$q('#am-t').value, cid=$q('#am-c').value, cnt=+$q('#am-n').value;
  if(!tid||!cid) return toast('اختر المعلم والفصل','err');
  const t=D.teachers.find(x=>x.id===tid);
  const ex=D.assignments.find(a=>a.teacherId===tid&&a.classId===cid);
  if(ex){ ex.count=cnt; toast('تم التحديث'); }
  else D.assignments.push({id:'a'+Date.now(),teacherId:tid,classId:cid,count:cnt,subject:t.subject,color:t.color});
  closeM('am'); renderASG(); updateStats();
}
function delASG(id){ D.assignments=D.assignments.filter(a=>a.id!==id); renderASG(); updateStats(); }
function autoAssign(){
  if(!D.teachers.length||!D.classes.length) return toast('أضف معلمين وفصولاً','err');
  if(!confirm('إنشاء إسناد تلقائي؟')) return;
  D.classes.forEach(cls=>D.teachers.forEach(t=>{ if(!D.assignments.find(a=>a.teacherId===t.id&&a.classId===cls.id)){ const tot=D.assignments.filter(a=>a.teacherId===t.id).reduce((s,a)=>s+a.count,0); if(tot+4<=t.maxLoad) D.assignments.push({id:'a'+Date.now()+Math.random(),teacherId:t.id,classId:cls.id,count:4,subject:t.subject,color:t.color}); } }));
  renderASG(); updateStats(); toast('تم الإسناد التلقائي','ok');
}
function renderASG(){
  const tb=$q('#asg-tb'), em=$q('#asg-em'); tb.innerHTML='';
  if(!D.assignments.length){ em.style.display='block'; return; } em.style.display='none';
  D.assignments.forEach(a=>{ const t=D.teachers.find(x=>x.id===a.teacherId), cls=D.classes.find(x=>x.id===a.classId); if(!t||!cls) return; tb.innerHTML+=`<tr><td><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${t.color};margin-left:5px"></span><strong>${t.name}</strong></td><td>${a.subject}</td><td><span class="tag" style="background:#ede9fe;color:#5b21b6">${cls.name}</span></td><td><strong>${a.count}</strong></td><td><button class="btn bd bsm" onclick="delASG('${a.id}')"><i class="fas fa-times"></i></button></td></tr>`; });
  $q('#nb-a').textContent=D.assignments.length;
}

// ══════════════════════════════════════════
//  CONSTRAINTS
// ══════════════════════════════════════════
function getCst(tid){ if(!D.constraints[tid]) D.constraints[tid]={blocked:[],preferred:[],maxConsec:3,maxPerDay:6}; return D.constraints[tid]; }
function isBlocked(tid,d,p){ return getCst(tid).blocked.some(([dd,pp])=>dd===d&&pp===p); }
function isPreferred(tid,d,p){ return getCst(tid).preferred.some(([dd,pp])=>dd===d&&pp===p); }

function fillConstraintSel(){
  const sel=$q('#cst-teacher-sel'); sel.innerHTML='<option value="">-- اختر معلماً --</option>';
  D.teachers.forEach(t=>sel.innerHTML+=`<option value="${t.id}">${t.name} (${t.subject})</option>`);
  // Update badge
  const total=D.teachers.reduce((s,t)=>s+(getCst(t.id).blocked.length+getCst(t.id).preferred.length),0);
  $q('#nb-cst').textContent=total||'!';
}

function renderConstraints(){
  const tid=$q('#cst-teacher-sel').value;
  const body=$q('#cst-body');
  if(!tid){ body.innerHTML=`<div class="es"><i class="fas fa-ban"></i><p>اختر معلماً لتحرير قيوده.</p></div>`; return; }
  const t=D.teachers.find(x=>x.id===tid);
  const cst=getCst(tid);
  const days=D.school.schoolDays, periods=D.school.periods;

  let html=`
  <div class="cst-legend">
    <strong style="font-size:12px">انقر لتبديل:</strong>
    <span><span class="dot" style="background:#f1f5f9;border:1px solid #cbd5e1"></span> متاح</span>
    <span><span class="dot" style="background:#fee2e2"></span> محجوب (لن تُجدَّل)</span>
    <span><span class="dot" style="background:#d1fae5"></span> مفضّل (يُرجَّح)</span>
    <span style="font-size:10px;color:var(--muted)">(انقر مرة = محجوب · مرتين = مفضّل · ثلاث = متاح)</span>
  </div>
  <div style="background:#fff;border-radius:12px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,.06);margin-bottom:14px">
    <h4 style="font-size:13px;font-weight:700;margin-bottom:12px">
      <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${t.color};margin-left:7px"></span>
      قيود الحصص: ${t.name}
    </h4>
    <div style="overflow-x:auto">
    <table style="border-collapse:separate;border-spacing:3px">
      <thead><tr><th style="text-align:right;padding:4px 8px;font-size:11px;color:var(--muted);font-weight:600;background:none">اليوم \ الحصة</th>`;
  for(let p=0;p<periods;p++) html+=`<th style="width:40px;text-align:center;font-size:11px;font-weight:600;color:var(--muted);padding:4px;background:none">ح${p+1}</th>`;
  html+=`</tr></thead><tbody>`;

  days.forEach(d=>{
    const isOff=!t.workingDays.includes(d);
    html+=`<tr><td style="font-size:11px;font-weight:600;padding:4px 8px;color:${isOff?'#ef4444':'var(--text)'};white-space:nowrap">${DAYS[d]}${isOff?' (إجازة)':''}</td>`;
    for(let p=0;p<periods;p++){
      const blk=isBlocked(tid,d,p), pref=isPreferred(tid,d,p);
      const bg=isOff?'#fef2f2':blk?'#fee2e2':pref?'#d1fae5':'#f1f5f9';
      const cl=isOff?'#f87171':blk?'#dc2626':pref?'#059669':'#94a3b8';
      const ico=isOff?'—':blk?'✕':pref?'★':'';
      html+=`<td style="padding:0"><button onclick="toggleSlot('${tid}',${d},${p})" ${isOff?'disabled':''} style="width:40px;height:38px;border-radius:7px;border:1px solid ${isOff?'#fecaca':blk?'#fca5a5':pref?'#6ee7b7':'#e2e8f0'};background:${bg};color:${cl};cursor:${isOff?'not-allowed':'pointer'};font-size:13px;font-weight:700;transition:.12s;font-family:Cairo,sans-serif" title="${isOff?'يوم إجازة':blk?'محجوب - انقر للتغيير':pref?'مفضّل - انقر للتغيير':'متاح - انقر لتغيير'}">${ico}</button></td>`;
    }
    html+='</tr>';
  });
  html+=`</tbody></table></div></div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div style="background:#fff;border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06)">
      <h4 style="font-size:12px;font-weight:700;margin-bottom:10px"><i class="fas fa-layer-group" style="color:var(--acc);margin-left:5px"></i>قيود الكمية اليومية</h4>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <label style="font-size:12px">الحد الأقصى لحصص في اليوم</label>
        <input type="number" value="${cst.maxPerDay}" min="1" max="${periods}" oninput="getCst('${tid}').maxPerDay=+this.value" style="width:55px;padding:4px 7px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:Cairo,sans-serif;text-align:center">
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between">
        <label style="font-size:12px">الحد الأقصى للحصص المتتالية</label>
        <input type="number" value="${cst.maxConsec}" min="1" max="${periods}" oninput="getCst('${tid}').maxConsec=+this.value" style="width:55px;padding:4px 7px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:Cairo,sans-serif;text-align:center">
      </div>
    </div>
    <div style="background:#fff;border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06)">
      <h4 style="font-size:12px;font-weight:700;margin-bottom:8px"><i class="fas fa-info-circle" style="color:var(--muted);margin-left:5px"></i>ملخص القيود</h4>
      <div style="font-size:12px;color:var(--muted);line-height:2">
        <div>محجوبة: <strong style="color:var(--danger)">${cst.blocked.length} حصة</strong></div>
        <div>مفضّلة: <strong style="color:var(--success)">${cst.preferred.length} حصة</strong></div>
        <div>أقصى يومي: <strong>${cst.maxPerDay}</strong></div>
        <div>أقصى متتالي: <strong>${cst.maxConsec}</strong></div>
      </div>
    </div>
  </div>`;

  body.innerHTML=html;
  fillConstraintSel();
}

function toggleSlot(tid,d,p){
  const cst=getCst(tid);
  const bi=cst.blocked.findIndex(([dd,pp])=>dd===d&&pp===p);
  const pi=cst.preferred.findIndex(([dd,pp])=>dd===d&&pp===p);
  if(bi>=0){ cst.blocked.splice(bi,1); cst.preferred.push([d,p]); }       // blocked→preferred
  else if(pi>=0){ cst.preferred.splice(pi,1); }                             // preferred→free
  else { cst.blocked.push([d,p]); }                                         // free→blocked
  renderConstraints();
}

// ══════════════════════════════════════════
//  SCHEDULER ENGINE
// ══════════════════════════════════════════
let chosenAlgo='bt';
function selAlgo(a){
  chosenAlgo=a;
  $q('#algo-bt').classList.toggle('on',a==='bt');
  $q('#algo-gr').classList.toggle('on',a==='gr');
}

// ── SCORING FUNCTION ──
function scoreSchedule(sched){
  const days=D.school.schoolDays, periods=D.school.periods;
  const weights={ gap:+$q('#w-gap').value, bal:+$q('#w-bal').value, pref:+$q('#w-pref').value, comp:+$q('#w-comp').value, rep:+$q('#w-rep').value };
  let totalW=Object.values(weights).reduce((s,v)=>s+v,0)||1;
  let penalty=0, bonus=0;

  D.teachers.forEach(t=>{
    const cst=getCst(t.id);
    days.forEach(d=>{
      // gather teacher's periods on this day sorted
      const teacherPeriods=[];
      for(let p=0;p<periods;p++){
        const slot=sched[d]?.[p]||{};
        if(Object.values(slot).some(x=>x?.teacherId===t.id)) teacherPeriods.push(p);
      }
      const cnt=teacherPeriods.length;
      // balance: penalize uneven distribution
      const avgPerDay=(D.assignments.filter(a=>a.teacherId===t.id).reduce((s,a)=>s+a.count,0))/days.length;
      penalty+=weights.bal*Math.abs(cnt-avgPerDay)*0.5;
      // consecutive: penalize long runs
      let run=0, maxRun=0;
      for(let i=0;i<teacherPeriods.length;i++){
        if(i>0&&teacherPeriods[i]-teacherPeriods[i-1]===1) run++;
        else run=0;
        maxRun=Math.max(maxRun,run);
      }
      if(maxRun>=cst.maxConsec) penalty+=weights.gap*(maxRun-cst.maxConsec+1)*3;
      // gaps (free periods between lessons): penalize
      if(teacherPeriods.length>1){
        const span=teacherPeriods[teacherPeriods.length-1]-teacherPeriods[0]+1;
        const gaps=span-teacherPeriods.length;
        penalty+=weights.comp*gaps*0.8;
      }
      // preferred slots: bonus
      for(const [pd,pp] of cst.preferred){
        if(pd===d&&teacherPeriods.includes(pp)) bonus+=weights.pref*2;
      }
      // blocked slots: hard violation (should not happen)
      for(const [bd,bp] of cst.blocked){
        if(bd===d&&teacherPeriods.includes(bp)) penalty+=100;
      }
    });
  });

  // subject repeat per class per day
  D.classes.forEach(cls=>{
    days.forEach(d=>{
      const subjectCount={};
      for(let p=0;p<periods;p++){
        const cell=sched[d]?.[p]?.[cls.id];
        if(cell){ subjectCount[cell.subject]=(subjectCount[cell.subject]||0)+1; }
      }
      Object.values(subjectCount).forEach(cnt=>{ if(cnt>1) penalty+=weights.rep*(cnt-1)*2; });
    });
  });

  // Max score = 100
  const raw=Math.max(0,100-penalty+bonus*0.5);
  return Math.min(100,Math.round(raw));
}

// ── CONSTRAINT CHECKER ──
function canPlaceCell(sched,tid,d,p,classId,fromD=null,fromP=null,fromC=null){
  const t=D.teachers.find(x=>x.id===tid);
  if(!t||!t.workingDays.includes(d)) return {ok:false,reason:`${t?.name} لا يعمل يوم ${DAYS[d]}`};
  if(!D.school.schoolDays.includes(d)) return {ok:false,reason:'يوم غير دراسي'};
  const cst=getCst(tid);
  // blocked slot
  if(isBlocked(tid,d,p)) return {ok:false,reason:`الحصة ${p+1} يوم ${DAYS[d]} محجوبة لهذا المعلم`};
  const slot=sched[d]?.[p]||{};
  // teacher busy?
  for(const cid of Object.keys(slot)){
    if(slot[cid]?.teacherId===tid){
      if(fromD===d&&fromP===p&&cid===fromC) continue; // moving from this spot
      return {ok:false,reason:`${t.name} مشغول الحصة ${p+1} يوم ${DAYS[d]}`};
    }
  }
  // class busy?
  if(slot[classId]){
    if(fromD===d&&fromP===p&&fromC===classId){/* moving from same spot, ok */}
    else return {ok:false,reason:`الفصل مشغول الحصة ${p+1} يوم ${DAYS[d]}`};
  }
  // max per day
  const teacherToday=[];
  for(let pp=0;pp<D.school.periods;pp++){
    const s=sched[d]?.[pp]||{};
    if(Object.values(s).some(x=>x?.teacherId===tid)){
      if(!(fromD===d&&fromP===pp)) teacherToday.push(pp);
    }
  }
  if(teacherToday.length>=cst.maxPerDay) return {ok:false,reason:`تجاوز الحد الأقصى (${cst.maxPerDay}) لحصص اليوم`};
  // max consecutive
  const allToday=[...teacherToday,p].sort((a,b)=>a-b);
  let maxRun=0,run=0;
  for(let i=0;i<allToday.length;i++){ if(i>0&&allToday[i]-allToday[i-1]===1) run++; else run=0; maxRun=Math.max(maxRun,run); }
  if(maxRun>=cst.maxConsec) return {ok:false,reason:`تجاوز الحد الأقصى (${cst.maxConsec}) للحصص المتتالية`};
  return {ok:true};
}

// ── SORT TASKS: MRV (Most Restricted Variable first) ──
function sortTasksMRV(tasks){
  return tasks.map(task=>{
    const t=D.teachers.find(x=>x.id===task.teacherId);
    const cst=getCst(task.teacherId);
    const days=D.school.schoolDays, periods=D.school.periods;
    let available=0;
    days.forEach(d=>{
      if(!t.workingDays.includes(d)) return;
      for(let p=0;p<periods;p++){
        if(!isBlocked(task.teacherId,d,p)) available++;
      }
    });
    // Fewer available slots = more restricted = higher priority
    const degree=D.assignments.filter(a=>a.teacherId===task.teacherId||a.classId===task.classId).length;
    return {...task, _avail:available, _deg:degree, _pref:cst.preferred.length};
  }).sort((a,b)=>{
    // primary: most blocked (least available) first
    if(a._avail!==b._avail) return a._avail-b._avail;
    // secondary: most constrained (highest degree) first
    return b._deg-a._deg;
  });
}

// ── SLOT SCORER (for ordering slots when placing) ──
function scoreSlot(sched,task,d,p,weights){
  let score=0;
  const tid=task.teacherId, cid=task.classId;
  const cst=getCst(tid);
  // preferred bonus
  if(isPreferred(tid,d,p)) score+=weights.pref*10;
  // balance: prefer days with fewer lessons for this teacher
  const teacherToday=Object.values(sched[d]||{}).filter(s=>Object.values(s).some(x=>x?.teacherId===tid)).length;
  score-=weights.bal*teacherToday*2;
  // compactness: prefer slots adjacent to existing lessons
  const hasAdj=(sched[d]?.[p-1]&&Object.values(sched[d][p-1]).some(x=>x?.teacherId===tid))||(sched[d]?.[p+1]&&Object.values(sched[d][p+1]||{}).some(x=>x?.teacherId===tid));
  if(hasAdj) score+=weights.comp*3;
  // subject repeat penalty
  const subjectToday=Object.values(sched[d]||{}).filter(s=>s[cid]?.subject===task.subject).length;
  score-=weights.rep*subjectToday*5;
  // gap penalty: penalize if placing creates gaps
  const allToday=[];
  for(let pp=0;pp<D.school.periods;pp++) if(Object.values(sched[d]?.[pp]||{}).some(x=>x?.teacherId===tid)) allToday.push(pp);
  if(allToday.length>0){
    const minP=Math.min(...allToday,p), maxP=Math.max(...allToday,p);
    score-=weights.gap*(maxP-minP-allToday.length)*1.5;
  }
  return score;
}

// ── GREEDY ALGORITHM ──
async function runGreedy(tasks,weights,addLog,setProgress){
  const sched={};
  D.school.schoolDays.forEach(d=>{ sched[d]={}; for(let p=0;p<D.school.periods;p++) sched[d][p]={}; });
  const tLoad={};
  D.teachers.forEach(t=>tLoad[t.id]=0);
  let ok=0,fail=0;
  const sortedTasks=sortTasksMRV(tasks);
  addLog(`> MRV: ترتيب ${sortedTasks.length} حصة حسب الأكثر تقييداً...`,'info');
  await sleep(60);

  for(let i=0;i<sortedTasks.length;i++){
    const task=sortedTasks[i];
    const teacher=D.teachers.find(x=>x.id===task.teacherId);
    const cst=getCst(task.teacherId);
    if(tLoad[task.teacherId]>=teacher.maxLoad){ fail++; continue; }

    // Build candidate slots with scores
    let slots=[];
    for(const d of D.school.schoolDays){
      if(!teacher.workingDays.includes(d)) continue;
      for(let p=0;p<D.school.periods;p++){
        const chk=canPlaceCell(sched,task.teacherId,d,p,task.classId);
        if(chk.ok) slots.push({d,p,score:scoreSlot(sched,task,d,p,weights)});
      }
    }
    slots.sort((a,b)=>b.score-a.score); // best slot first

    let placed=false;
    for(const {d,p} of slots){
      sched[d][p][task.classId]={teacherId:task.teacherId,subject:task.subject,color:task.color,assignId:task.assignId};
      tLoad[task.teacherId]++; ok++; placed=true; break;
    }
    if(!placed) fail++;
    if(i%20===0){ setProgress((i/sortedTasks.length)*85); await sleep(4); }
  }
  return {sched,ok,fail};
}

// ── BACKTRACKING ALGORITHM ──
async function runBacktracking(tasks,weights,addLog,setProgress){
  const sched={};
  D.school.schoolDays.forEach(d=>{ sched[d]={}; for(let p=0;p<D.school.periods;p++) sched[d][p]={}; });
  const tLoad={};
  D.teachers.forEach(t=>tLoad[t.id]=0);

  const sortedTasks=sortTasksMRV(tasks);
  addLog(`> Backtracking: ${sortedTasks.length} حصة مرتبة بـ MRV...`,'info');
  await sleep(60);

  // For large problems, use BT with early termination after max attempts
  const MAX_BACKTRACKS=1500;
  let backtracks=0, ok=0, fail=0;

  async function bt(idx){
    if(idx>=sortedTasks.length) return true;
    const task=sortedTasks[idx];
    const teacher=D.teachers.find(x=>x.id===task.teacherId);
    if(tLoad[task.teacherId]>=teacher.maxLoad){ fail++; return await bt(idx+1); }

    // Build + sort slots
    let slots=[];
    for(const d of D.school.schoolDays){
      if(!teacher.workingDays.includes(d)) continue;
      for(let p=0;p<D.school.periods;p++){
        if(canPlaceCell(sched,task.teacherId,d,p,task.classId).ok)
          slots.push({d,p,score:scoreSlot(sched,task,d,p,weights)});
      }
    }
    slots.sort((a,b)=>b.score-a.score);

    for(const {d,p} of slots){
      if(backtracks>MAX_BACKTRACKS) break; // give up BT, place greedily
      // Place
      sched[d][p][task.classId]={teacherId:task.teacherId,subject:task.subject,color:task.color,assignId:task.assignId};
      tLoad[task.teacherId]++;
      ok++;

      if(idx%30===0){ setProgress((idx/sortedTasks.length)*75); await sleep(2); }

      // Forward check: is next task still feasible?
      if(idx+1<sortedTasks.length){
        const next=sortedTasks[idx+1];
        const nt=D.teachers.find(x=>x.id===next.teacherId);
        let nextFeasible=tLoad[next.teacherId]>=nt.maxLoad; // already full is ok (we'll skip)
        if(!nextFeasible){
          for(const dd of D.school.schoolDays){
            if(!nt.workingDays.includes(dd)) continue;
            for(let pp=0;pp<D.school.periods;pp++){
              if(canPlaceCell(sched,next.teacherId,dd,pp,next.classId).ok){ nextFeasible=true; break; }
            }
            if(nextFeasible) break;
          }
        }
        if(!nextFeasible){
          // Backtrack
          delete sched[d][p][task.classId]; tLoad[task.teacherId]--; ok--; backtracks++;
          continue;
        }
      }
      if(await bt(idx+1)) return true;
      // If recursive call failed, backtrack
      delete sched[d][p][task.classId]; tLoad[task.teacherId]--; ok--; backtracks++;
    }

    // Couldn't place this task
    fail++;
    return await bt(idx+1); // continue without this task
  }

  await bt(0);
  addLog(`> انتهى Backtracking. تراجعات: ${backtracks}`,'info');
  return {sched,ok,fail};
}

// ── LOCAL SEARCH (SWAP OPTIMIZATION) ──
async function localSearch(sched,weights,iterations,addLog,setProgress){
  addLog(`> بدء Local Search (${iterations} تبادل)...`,'info');
  const days=D.school.schoolDays, periods=D.school.periods;
  let currentScore=scoreSchedule(sched);
  addLog(`> الجودة الابتدائية: ${currentScore}/100`,'info');
  const useSA=$q('#opt-sa').checked;
  let temp=50, cooling=0.97; // simulated annealing params

  for(let iter=0;iter<iterations;iter++){
    // Pick two random placed lessons and try swapping them
    const allCells=[];
    days.forEach(d=>{ for(let p=0;p<periods;p++){ const slot=sched[d]?.[p]||{}; Object.keys(slot).forEach(cid=>{ if(slot[cid]) allCells.push({d,p,cid,data:{...slot[cid]}}); }); } });
    if(allCells.length<2) break;

    const i1=Math.floor(Math.random()*allCells.length);
    let i2=Math.floor(Math.random()*allCells.length);
    if(i1===i2) continue;
    const c1=allCells[i1], c2=allCells[i2];

    // Try swap: c1.data into c2 position, c2.data into c1 position
    const chk1=canPlaceCell(sched,c1.data.teacherId,c2.d,c2.p,c1.cid,c1.d,c1.p,c1.cid);
    const chk2=canPlaceCell(sched,c2.data.teacherId,c1.d,c1.p,c2.cid,c2.d,c2.p,c2.cid);
    if(!chk1.ok||!chk2.ok) continue;

    // Also ensure no teacher conflict after swap
    if(c1.data.teacherId===c2.data.teacherId&&c1.d===c2.d&&c1.p===c2.p) continue;

    // Do swap
    delete sched[c1.d][c1.p][c1.cid]; delete sched[c2.d][c2.p][c2.cid];
    if(!sched[c2.d][c2.p]) sched[c2.d][c2.p]={};
    if(!sched[c1.d][c1.p]) sched[c1.d][c1.p]={};
    sched[c2.d][c2.p][c1.cid]=c1.data; sched[c1.d][c1.p][c2.cid]=c2.data;

    const newScore=scoreSchedule(sched);
    const delta=newScore-currentScore;
    // Accept if better, or (SA) accept with probability
    const accept=delta>0||(useSA&&Math.random()<Math.exp(delta/temp));
    if(accept){ currentScore=newScore; }
    else{ // revert
      delete sched[c2.d][c2.p][c1.cid]; delete sched[c1.d][c1.p][c2.cid];
      sched[c1.d][c1.p][c1.cid]=c1.data; sched[c2.d][c2.p][c2.cid]=c2.data;
    }
    if(useSA) temp=Math.max(0.1,temp*cooling);
    if(iter%100===0) setProgress(85+((iter/iterations)*13));
  }
  addLog(`> Local Search انتهت. الجودة النهائية: ${currentScore}/100`,'ok');
  return currentScore;
}

async function runGen(){
  const btn=$q('#gen-btn'), log=$q('#gen-logs'), fill=$q('#pbf'), wrap=$q('#pbw');
  const sb=$q('#score-bar');
  btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> يعمل...';
  wrap.style.display='block'; log.style.display='block'; log.innerHTML=''; fill.style.width='0%'; sb.style.display='none';
  const addLog=(msg,cls='')=>{ log.innerHTML+=`<div class="${cls?''+cls:''}">${msg}</div>`; log.scrollTop=log.scrollHeight; };
  const setProgress=p=>fill.style.width=p+'%';

  D.schedule={}; fixSched();
  const weights={ gap:+$q('#w-gap').value, bal:+$q('#w-bal').value, pref:+$q('#w-pref').value, comp:+$q('#w-comp').value, rep:+$q('#w-rep').value };

  // Build tasks list
  const tasks=[];
  D.assignments.forEach(a=>{ const t=D.teachers.find(x=>x.id===a.teacherId); if(!t) return; for(let i=0;i<a.count;i++) tasks.push({teacherId:a.teacherId,classId:a.classId,subject:a.subject,color:t.color,assignId:a.id}); });
  addLog(`> إجمالي المهام: ${tasks.length} حصة`);
  await sleep(60);

  let result;
  if(chosenAlgo==='bt'){
    addLog('> الخوارزمية: Backtracking + MRV + Forward Checking','info');
    result=await runBacktracking(tasks,weights,addLog,setProgress);
  } else {
    addLog('> الخوارزمية: Greedy مع MRV + Slot Scoring','info');
    result=await runGreedy(tasks,weights,addLog,setProgress);
  }

  D.schedule=result.sched;
  addLog(`> ✓ تم وضع ${result.ok} حصة بنجاح`,'ok');
  if(result.fail>0) addLog(`> ✗ فشل توزيع ${result.fail} حصة`,'err');
  setProgress(85);

  // Optimization pass
  let finalScore=scoreSchedule(D.schedule);
  if($q('#opt-ls').checked){
    const itr=+$q('#opt-itr').value;
    finalScore=await localSearch(D.schedule,weights,itr,addLog,setProgress);
  }

  setProgress(100);
  addLog(`> ✅ اكتمل التوزيع! الجودة: ${finalScore}/100`,'ok');

  // Show score
  $q('#score-val').textContent=finalScore;
  sb.style.display='flex';
  updateDashScore(finalScore);
  updateStats();
  btn.disabled=false; btn.innerHTML='<i class="fas fa-play"></i> إعادة التوزيع';
  toast(`✓ ${result.ok} حصة موزعة · جودة ${finalScore}/100`,result.ok>0?'ok':'err');
}

function updateDashScore(s){
  const w=$q('#dash-score'); w.style.display='flex';
  $q('#dsv').textContent=s;
  $q('#dsbf').style.width=s+'%';
  const desc=s>=85?'جدول ممتاز يحترم جميع القيود':s>=70?'جدول جيد مع بعض التسويات':s>=50?'جدول مقبول، يمكن التحسين يدوياً':'يحتاج مراجعة يدوية';
  $q('#dsd').textContent=desc;
}

function clearSched(){ if(!confirm('مسح الجدول؟')) return; D.schedule={}; fixSched(); updateStats(); toast('تم المسح'); $q('#dash-score').style.display='none'; }

// ══════════════════════════════════════════
//  STATS
// ══════════════════════════════════════════
function updateStats(){
  const days=D.school.schoolDays, periods=D.school.periods;
  let sched=0;
  days.forEach(d=>{ for(let p=0;p<periods;p++) sched+=Object.keys(D.schedule[d]?.[p]||{}).length; });
  const total=D.assignments.reduce((s,a)=>s+a.count,0);
  $q('#sc').textContent=D.classes.length;
  $q('#st').textContent=D.teachers.length;
  $q('#sa').textContent=total;
  $q('#ss').textContent=sched;
  $q('#su').textContent=Math.max(0,total-sched);
  $q('#nb-c').textContent=D.classes.length;
  $q('#nb-t').textContent=D.teachers.length;
  $q('#nb-a').textContent=D.assignments.length;
}

// ══════════════════════════════════════════
//  TIMETABLE + DRAG & DROP
// ══════════════════════════════════════════
let ttView='class', ttIdx=0;
let drag={type:null,assignId:null,teacherId:null,classId:null,subject:null,color:null,fromD:null,fromP:null,fromC:null};

function setView(v,btn){ ttView=v; ttIdx=0; $a('.vt').forEach(b=>b.classList.remove('on')); btn.classList.add('on'); renderPool(); renderGrid(); }
function selEnt(id){ const ents=ttView==='class'?D.classes:D.teachers; const i=ents.findIndex(e=>e.id===id); if(i>=0){ ttIdx=i; renderGrid(); renderPool(); } }
function navPrev(){ const ents=ttView==='class'?D.classes:D.teachers; if(!ents.length) return; ttIdx=(ttIdx-1+ents.length)%ents.length; renderGrid(); renderPool(); }
function navNext(){ const ents=ttView==='class'?D.classes:D.teachers; if(!ents.length) return; ttIdx=(ttIdx+1)%ents.length; renderGrid(); renderPool(); }

function countSchedMap(){
  const m={};
  Object.values(D.schedule).forEach(dy=>Object.values(dy).forEach(p=>Object.values(p).forEach(c=>{ if(c?.assignId) m[c.assignId]=(m[c.assignId]||0)+1; })));
  return m;
}

function renderPool(){
  const body=$q('#pool-body'), badge=$q('#pool-badge');
  body.innerHTML='';
  const sMap=countSchedMap();
  let tot=0;
  const ents=ttView==='class'?D.classes:D.teachers;
  const entity=ents[ttIdx];

  D.assignments.forEach(a=>{
    const rem=a.count-(sMap[a.id]||0); if(rem<=0) return;
    if(ttView==='class'&&entity&&a.classId!==entity.id) return;
    if(ttView==='teacher'&&entity&&a.teacherId!==entity.id) return;
    tot+=rem;
    const t=D.teachers.find(x=>x.id===a.teacherId), cls=D.classes.find(x=>x.id===a.classId);
    if(!t||!cls) return;
    const card=document.createElement('div'); card.className='pc-card'; card.style.background=t.color; card.draggable=true; card.dataset.aid=a.id;
    card.innerHTML=`<span class="ps">${a.subject}</span><span class="pm">${ttView==='class'?t.name:cls.name}</span><span class="pn">${rem}</span>`;
    card.addEventListener('dragstart',e=>{ drag={type:'pool',assignId:a.id,teacherId:a.teacherId,classId:a.classId,subject:a.subject,color:t.color}; card.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; showGhost(a.subject,t.color,e); });
    card.addEventListener('dragend',()=>{ card.classList.remove('dragging'); hideGhost(); });
    body.appendChild(card);
  });

  badge.textContent=tot; badge.style.background=tot===0?'#10b981':'#ef4444';
  if(!body.children.length) body.innerHTML=`<div style="padding:22px 10px;text-align:center;color:#94a3b8"><i class="fas fa-check-circle" style="font-size:26px;display:block;margin-bottom:8px;color:#10b981"></i><p style="font-size:11px">${D.assignments.length?'جميع الحصص موزعة!':'لا يوجد إسناد.'}</p></div>`;
}

function renderGrid(){
  const tbl=$q('#tbl'), days=D.school.schoolDays, periods=D.school.periods;
  const ents=ttView==='class'?D.classes:D.teachers;
  const sel=$q('#ent-sel');
  if(!ents.length){ tbl.innerHTML=`<tr><td style="padding:40px;text-align:center;color:#94a3b8">أضف ${ttView==='class'?'فصولاً':'معلمين'} أولاً</td></tr>`; return; }
  if(ttIdx>=ents.length) ttIdx=0;
  const entity=ents[ttIdx];
  sel.innerHTML=''; ents.forEach((e,i)=>{ const o=document.createElement('option'); o.value=e.id; o.textContent=ttView==='class'?`${e.name} - ${e.grade}`:e.name; if(i===ttIdx) o.selected=true; sel.appendChild(o); });

  let html='<thead><tr><th class="eth">اليوم</th>';
  for(let p=0;p<periods;p++) html+=`<th class="pth">ح${p+1}</th>`;
  html+='</tr></thead><tbody>';

  days.forEach(d=>{
    const isOff=ttView==='teacher'&&!entity.workingDays.includes(d);
    html+=`<tr><th class="dth">${DAYS[d]}</th>`;
    for(let p=0;p<periods;p++){
      const cellId=`c_${d}_${p}`;
      const blk=ttView==='teacher'&&!isOff&&isBlocked(entity.id,d,p);
      const pref=ttView==='teacher'&&!isOff&&isPreferred(entity.id,d,p);
      let cc='tc'+(isOff?' off':blk?' blocked-slot':'');
      html+=`<td class="${cc}" id="${cellId}" ondragover="cOver(event,this,${d},${p})" ondragleave="cLeave(this)" ondrop="cDrop(event,this,${d},${p},'${entity.id}')">`;
      if(blk) html+=`<div style="height:100%;background:repeating-linear-gradient(45deg,#fdf4ff,#fdf4ff 3px,#f5f3ff 3px,#f5f3ff 9px);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:10px;color:#7c3aed;font-weight:700">محجوب</div>`;
      else if(pref) html+=`<div class="cph" style="color:#10b981"><i class="fas fa-star"></i></div>`;
      else if(isOff) html+='';
      else html+=`<div class="cph"><i class="fas fa-plus"></i></div>`;
      html+='</td>';
    }
    html+='</tr>';
  });
  html+='</tbody>';
  tbl.innerHTML=html;

  // Fill cells with data
  days.forEach(d=>{
    const isOff=ttView==='teacher'&&!entity.workingDays.includes(d);
    for(let p=0;p<D.school.periods;p++){
      const td=document.getElementById(`c_${d}_${p}`); if(!td) continue;
      if(isOff||isBlocked(entity.id,d,p)&&ttView==='teacher') continue;
      const slot=D.schedule[d]?.[p]||{};
      let lesson=null;
      if(ttView==='class'){
        lesson=slot[entity.id];
        if(lesson){ const t=D.teachers.find(x=>x.id===lesson.teacherId); lesson={...lesson,_label:t?.name||'?'}; }
      } else {
        for(const cid of Object.keys(slot)){ if(slot[cid]?.teacherId===entity.id){ const cls=D.classes.find(x=>x.id===cid); lesson={...slot[cid],_classId:cid,_label:cls?.name||'?'}; break; } }
      }
      if(lesson){
        const fromC=ttView==='class'?entity.id:lesson._classId;
        td.innerHTML=`<div class="cl" draggable="true" style="background:${lesson.color}"><span class="cs2">${lesson.subject}</span><span class="cm2">${lesson._label}</span><button class="cdel" onclick="removeCell(${d},${p},'${fromC}',event)"><i class="fas fa-times"></i></button></div>`;
        const cl=td.querySelector('.cl');
        if(cl){ cl.addEventListener('dragstart',e=>{ const fc=ttView==='class'?entity.id:lesson._classId; drag={type:'cell',assignId:lesson.assignId,teacherId:lesson.teacherId,classId:lesson.classId||fc,subject:lesson.subject,color:lesson.color,fromD:d,fromP:p,fromC:fc}; cl.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; showGhost(lesson.subject,lesson.color,e); }); cl.addEventListener('dragend',()=>{ cl.classList.remove('dragging'); hideGhost(); renderGrid(); renderPool(); }); }
      }
    }
  });
}

function removeCell(d,p,cid,e){ e?.stopPropagation(); if(D.schedule[d]?.[p]) delete D.schedule[d][p][cid]; renderGrid(); renderPool(); updateStats(); }

function cOver(e,cell,d,p){ e.preventDefault(); if(!drag.type) return; const tc=ttView==='class'?$q('#ent-sel').value:drag.classId; const ok=canPlaceCell(D.schedule,drag.teacherId,d,p,tc,drag.fromD,drag.fromP,drag.fromC).ok; cell.classList.remove('dho','dok','dno'); cell.classList.add(ok?'dok':'dno'); }
function cLeave(cell){ cell.classList.remove('dho','dok','dno'); }
function cDrop(e,cell,d,p,entityId){
  e.preventDefault(); cell.classList.remove('dho','dok','dno'); if(!drag.type) return;
  const tCid=ttView==='class'?entityId:drag.classId;
  const chk=canPlaceCell(D.schedule,drag.teacherId,d,p,tCid,drag.fromD,drag.fromP,drag.fromC);
  if(!chk.ok){ toast(chk.reason,'err'); return; }
  if(drag.type==='cell'&&drag.fromD!==null) if(D.schedule[drag.fromD]?.[drag.fromP]) delete D.schedule[drag.fromD][drag.fromP][drag.fromC];
  if(!D.schedule[d]) D.schedule[d]={}; if(!D.schedule[d][p]) D.schedule[d][p]={};
  D.schedule[d][p][tCid]={teacherId:drag.teacherId,subject:drag.subject,color:drag.color,assignId:drag.assignId,classId:tCid};
  drag={type:null}; renderGrid(); renderPool(); updateStats();
}
function poolDrop(e){ e.preventDefault(); if(drag.type!=='cell') return; if(D.schedule[drag.fromD]?.[drag.fromP]) delete D.schedule[drag.fromD][drag.fromP][drag.fromC]; drag={type:null}; renderGrid(); renderPool(); updateStats(); toast('تم إرجاع الحصة'); }

// Drag ghost
const ghost=$q('#dg');
function showGhost(text,color,e){ ghost.textContent=text; ghost.style.background=color; ghost.style.display='block'; document.addEventListener('dragover',mvGhost); }
function mvGhost(e){ ghost.style.left=e.clientX+'px'; ghost.style.top=e.clientY+'px'; }
function hideGhost(){ ghost.style.display='none'; document.removeEventListener('dragover',mvGhost); }
document.addEventListener('dragend',()=>{ hideGhost(); drag={type:null}; });

// ══════════════════════════════════════════
//  OVERVIEW
// ══════════════════════════════════════════
let ovView='teacher';
function setOV(v){ ovView=v; $q('#ovt-btn').classList.toggle('on',v==='teacher'); $q('#ovc-btn').classList.toggle('on',v==='class'); renderOV(); }
function renderOV(){
  const tbl=$q('#ovtbl'), days=D.school.schoolDays, periods=D.school.periods;
  const ents=ovView==='teacher'?D.teachers:D.classes;
  if(!ents.length){ tbl.innerHTML='<tr><td style="padding:24px;text-align:center">لا يوجد بيانات</td></tr>'; return; }
  let h1=`<thead><tr><th class="sc" rowspan="2">${ovView==='teacher'?'المعلم':'الفصل'}</th>`;
  days.forEach(d=>h1+=`<th colspan="${periods}">${DAYS[d]}</th>`); h1+='</tr><tr>';
  days.forEach((d,di)=>{ for(let p=0;p<periods;p++) h1+=`<th${p===periods-1&&di<days.length-1?' class="ds"':''}>${p+1}</th>`; });
  h1+='</tr></thead><tbody>';
  let rows='';
  ents.forEach(ent=>{
    rows+=`<tr><td class="sc">${ent.name}${ovView==='teacher'?`<br><small style="color:var(--muted);font-weight:400">${ent.subject}</small>`:''}</td>`;
    days.forEach((d,di)=>{
      const isOff=ovView==='teacher'&&!ent.workingDays.includes(d);
      for(let p=0;p<periods;p++){
        const sep=p===periods-1&&di<days.length-1?' class="ds"':'';
        if(isOff){ rows+=`<td ${sep} class="oc"></td>`; continue; }
        const slot=D.schedule[d]?.[p]||{};
        let lesson=null;
        if(ovView==='teacher'){ for(const cid of Object.keys(slot)){ if(slot[cid]?.teacherId===ent.id){ const cls=D.classes.find(x=>x.id===cid); lesson={...slot[cid],label:cls?.name||'?'}; break; } } }
        else{ lesson=slot[ent.id]; if(lesson){ const t=D.teachers.find(x=>x.id===lesson.teacherId); lesson={...lesson,label:t?.name?.split(' ')[0]||'?'}; } }
        rows+=lesson?`<td ${sep}><span class="oc2" style="background:${lesson.color}">${lesson.label}</span></td>`:`<td ${sep}></td>`;
      }
    });
    rows+='</tr>';
  });
  tbl.innerHTML=h1+rows+'</tbody>';
}

// ══════════════════════════════════════════
//  REPORTS
// ══════════════════════════════════════════
function renderRP(){
  const grid=$q('#rpg'), rpScore=$q('#rp-score');
  grid.innerHTML=''; rpScore.style.display='none';
  if(!D.teachers.length){ grid.innerHTML=`<div class="es"><i class="fas fa-chart-bar"></i><p>لا يوجد بيانات.</p></div>`; return; }
  const days=D.school.schoolDays, periods=D.school.periods;
  const score=scoreSchedule(D.schedule);
  rpScore.style.display='block';
  rpScore.innerHTML=`<div class="score-widget"><div><div class="sw-val">${score}</div><div class="sw-lbl">جودة الجدول الكلية</div><div class="sw-sub">/ 100 نقطة</div></div><div style="flex:1"><div style="height:8px;background:rgba(255,255,255,.3);border-radius:99px;overflow:hidden"><div style="height:100%;width:${score}%;background:#fff;border-radius:99px"></div></div><div style="font-size:11px;opacity:.8;margin-top:4px">${score>=85?'ممتاز':score>=70?'جيد':score>=50?'مقبول':'يحتاج تحسين'}</div></div></div>`;

  D.teachers.forEach(t=>{
    let sched=0, gaps=0;
    days.forEach(d=>{
      if(!t.workingDays.includes(d)) return;
      const tPeriods=[];
      for(let p=0;p<periods;p++) if(Object.values(D.schedule[d]?.[p]||{}).some(x=>x?.teacherId===t.id)){ sched++; tPeriods.push(p); }
      if(tPeriods.length>1) gaps+=tPeriods[tPeriods.length-1]-tPeriods[0]+1-tPeriods.length;
    });
    const total=D.assignments.filter(a=>a.teacherId===t.id).reduce((s,a)=>s+a.count,0);
    const pct=t.maxLoad>0?Math.round((sched/t.maxLoad)*100):0;
    const col=pct>=90?'#ef4444':pct>=70?'#f59e0b':'#10b981';
    const cst=getCst(t.id);
    const card=document.createElement('div'); card.className='rpc';
    card.innerHTML=`<h4><span><span style="display:inline-block;width:9px;height:9px;border-radius:50%;background:${t.color};margin-left:5px"></span>${t.name}</span><span class="tag" style="background:#f1f5f9;color:#475569">${t.subject}</span></h4>
    <div class="lb-w"><div class="lb-t"><span>النصاب الموزع</span><span><strong>${sched}</strong> / ${t.maxLoad}</span></div><div class="lb"><div class="lbf" style="width:${Math.min(pct,100)}%;background:${col}"></div></div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:8px">
      <div style="background:#f8fafc;border-radius:7px;padding:7px;text-align:center"><div style="font-size:10px;color:var(--muted)">إسناد</div><div style="font-size:14px;font-weight:700">${total}</div></div>
      <div style="background:#f8fafc;border-radius:7px;padding:7px;text-align:center"><div style="font-size:10px;color:var(--muted)">فراغات</div><div style="font-size:14px;font-weight:700;color:${gaps>3?'#ef4444':'#10b981'}">${gaps}</div></div>
      <div style="background:#f8fafc;border-radius:7px;padding:7px;text-align:center"><div style="font-size:10px;color:var(--muted)">محجوب</div><div style="font-size:14px;font-weight:700;color:var(--danger)">${cst.blocked.length}</div></div>
    </div>`;
    grid.appendChild(card);
  });
}

// ══════════════════════════════════════════
//  MODAL HELPERS
// ══════════════════════════════════════════
function openM(id){ document.getElementById(id).classList.add('on'); }
function closeM(id){ document.getElementById(id).classList.remove('on'); }
$a('.mov').forEach(m=>m.addEventListener('click',e=>{ if(e.target===m) m.classList.remove('on'); }));

// ══════════════════════════════════════════
//  INIT
// ══════════════════════════════════════════
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
function init(){
  loadData(); initSettings();
  $q('#school-lbl').textContent=D.school.name||'غير محدد';
  updateStats();
  document.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey)&&e.key==='s'){ e.preventDefault(); saveData(); } });
}
init();
</script>
</body>
</html>
